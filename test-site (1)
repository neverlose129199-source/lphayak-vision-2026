import React, { useState, useEffect, useCallback } from 'react';
import { 
  Sparkles, ImageIcon, Loader2, Palette, 
  Download, Check, Zap, Sun, Leaf, Camera, 
  RefreshCw, Layers, Shield, AlertCircle,
  TrendingUp, ShoppingBag, Share2, Save, Trash2,
  DollarSign, Briefcase, ChevronRight, History
} from 'lucide-react';

const App = () => {
  const [activeTab, setActiveTab] = useState('generator');
  const [image, setImage] = useState(null);
  const [loading, setLoading] = useState(false);
  const [style, setStyle] = useState('earthy_retro');
  const [energy, setEnergy] = useState(100);
  const [inventory, setInventory] = useState([]);
  const [notification, setNotification] = useState(null);

  const apiKey = ""; // API Key provided by environment

  // --- Passive Energy Recovery ---
  useEffect(() => {
    const recoveryInterval = setInterval(() => {
      setEnergy(prev => (prev < 100 ? Math.min(100, prev + 2) : 100));
    }, 10000);
    return () => clearInterval(recoveryInterval);
  }, []);

  const showNotification = useCallback((msg) => {
    setNotification(msg);
    setTimeout(() => setNotification(null), 3000);
  }, []);

  const styles = [
    { 
      id: 'earthy_retro', 
      name: 'Earthy Retro', 
      desc: 'ส้มอิฐ & เขียวอะโวคาโด (ยอดนิยม)',
      prompt: "A majestic tiger portrait, 1970s vintage aesthetic, Earthy Retro color palette: terracotta orange, avocado green. High commercial quality, fine art texture." 
    },
    { 
      id: 'eco_premium', 
      name: 'Eco Premium', 
      desc: 'ลายเส้นธรรมชาติสำหรับสินค้า POD',
      prompt: "Minimalist tiger illustration, natural fiber textures, clean background, suitable for organic cotton printing, high contrast, premium eco-brand style." 
    },
    { 
      id: 'spiritual_digital', 
      name: 'Spiritual Digital', 
      desc: 'ยันต์พยัคฆ์ดิจิทัล เสริมบารมี',
      prompt: "Sacred tiger totem with glowing golden aura, sapphire blue eyes, divine symmetry, digital spiritual art, 8k resolution, cinematic lighting." 
    }
  ];

  const generateImage = async () => {
    if (energy < 25) {
      showNotification("พลังงานไม่พอสำหรับการเนรมิต (ต้องการ ๒๕%)");
      return;
    }

    setLoading(true);
    setImage(null);
    const selectedStyle = styles.find(s => s.id === style);

    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          instances: [{ prompt: selectedStyle.prompt }],
          parameters: { sampleCount: 1 }
        })
      });

      const result = await response.json();
      if (result.predictions?.[0]) {
        const base64Data = `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
        setImage(base64Data);
        setEnergy(prev => prev - 25);
        showNotification("นิมิตพยัคฆ์ปรากฏแล้ว");
      }
    } catch (err) {
      showNotification("การเชื่อมต่อขัดข้อง กรุณาลองใหม่");
    } finally {
      setLoading(false);
    }
  };

  const saveToInventory = () => {
    if (!image) return;
    const newItem = {
      id: Date.now(),
      url: image,
      style: style,
      price: "1,200 - 3,500 THB", // Estimated value based on style
      date: new Date().toLocaleDateString('th-TH')
    };
    setInventory([newItem, ...inventory]);
    showNotification("บันทึกลงคลังสินค้าแล้ว");
  };

  const renderMarketplace = () => (
    <div className="space-y-6 animate-in slide-in-from-right duration-500 pb-10">
      <div className="bg-gradient-to-br from-stone-800 to-stone-900 p-6 rounded-[2rem] border border-orange-900/20">
        <h3 className="text-orange-400 text-xs font-black uppercase tracking-widest mb-4">สรุปมูลค่าสินทรัพย์ดิจิทัล</h3>
        <div className="grid grid-cols-2 gap-4">
          <div className="bg-stone-900/50 p-4 rounded-2xl">
            <p className="text-[10px] text-stone-500 uppercase font-bold">จำนวนนิมิต</p>
            <p className="text-2xl font-black text-stone-100">{inventory.length}</p>
          </div>
          <div className="bg-stone-900/50 p-4 rounded-2xl">
            <p className="text-[10px] text-stone-500 uppercase font-bold">ประมาณการรายได้</p>
            <p className="text-2xl font-black text-green-500">{(inventory.length * 1200).toLocaleString()} ฿</p>
          </div>
        </div>
      </div>

      <div className="grid grid-cols-2 gap-3">
        {inventory.length === 0 ? (
          <div className="col-span-2 text-center py-20 text-stone-600 italic border-2 border-dashed border-stone-800 rounded-[2rem]">
            ยังไม่มีสินค้าในคลัง...
          </div>
        ) : (
          inventory.map(item => (
            <div key={item.id} className="bg-stone-900 rounded-3xl overflow-hidden border border-stone-800 group transition-all hover:border-orange-900/50">
              <div className="aspect-square relative">
                <img src={item.url} alt="Tiger" className="w-full h-full object-cover" />
                <div className="absolute top-2 right-2 flex gap-1">
                    <button className="p-2 bg-black/50 backdrop-blur-md rounded-full text-white"><Share2 size={12}/></button>
                </div>
              </div>
              <div className="p-3">
                <p className="text-[9px] font-black text-orange-500 uppercase">{item.style}</p>
                <p className="text-xs font-bold text-stone-300">{item.price}</p>
                <div className="flex justify-between items-center mt-2">
                    <span className="text-[8px] text-stone-600">{item.date}</span>
                    <button onClick={() => setInventory(inventory.filter(i => i.id !== item.id))}><Trash2 size={12} className="text-stone-700 hover:text-red-500"/></button>
                </div>
              </div>
            </div>
          ))
        )}
      </div>
    </div>
  );

  return (
    <div className="min-h-screen bg-[#1c1917] text-stone-200 font-sans p-6 pb-24 max-w-md mx-auto">
      {/* Header */}
      <header className="flex justify-between items-center mb-8">
        <div>
          <h1 className="text-xl font-black text-orange-200 italic uppercase">Phayak Business</h1>
          <p className="text-[9px] text-stone-500 font-bold tracking-[0.2em] uppercase">Monetize Your Vision 2026</p>
        </div>
        <div className="flex flex-col items-end gap-1">
          <div className="bg-stone-900 px-3 py-1 rounded-full border border-orange-900/30 flex items-center gap-2">
            <Zap size={12} className={energy >= 25 ? "text-yellow-500 fill-yellow-500" : "text-stone-700"} />
            <span className="font-mono text-xs">{energy}%</span>
          </div>
        </div>
      </header>

      {/* Tabs */}
      <div className="flex gap-2 mb-8 bg-stone-900 p-1 rounded-2xl border border-stone-800">
        <button onClick={() => setActiveTab('generator')} className={`flex-1 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all ${activeTab === 'generator' ? 'bg-orange-700 text-white shadow-lg' : 'text-stone-600 hover:text-stone-400'}`}>เนรมิต</button>
        <button onClick={() => setActiveTab('inventory')} className={`flex-1 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all ${activeTab === 'inventory' ? 'bg-orange-700 text-white shadow-lg' : 'text-stone-600 hover:text-stone-400'}`}>คลังสินค้า</button>
      </div>

      {activeTab === 'generator' ? (
        <div className="space-y-8 animate-in fade-in duration-500">
          {/* Main Canvas */}
          <div className="aspect-square bg-[#292524] rounded-[3rem] border-4 border-stone-800 relative overflow-hidden shadow-2xl group">
            {image ? (
              <div className="w-full h-full animate-in zoom-in duration-700">
                <img src={image} className="w-full h-full object-cover" alt="Vision" />
                <div className="absolute inset-0 bg-gradient-to-t from-black/70 via-transparent to-transparent flex items-end p-8">
                   <div className="w-full flex justify-between items-center">
                      <div>
                        <p className="text-[10px] font-black text-orange-400 uppercase tracking-widest">นิมิตพร้อมใช้งาน</p>
                        <p className="text-xs font-bold text-white">ประเมินมูลค่า: 2,500 ฿</p>
                      </div>
                      <button onClick={saveToInventory} className="bg-white text-stone-900 p-4 rounded-2xl shadow-xl hover:scale-105 transition-transform">
                        <ShoppingBag size={20} />
                      </button>
                   </div>
                </div>
              </div>
            ) : (
              <div className="absolute inset-0 flex flex-col items-center justify-center p-12 text-center opacity-40">
                {loading ? <Loader2 className="w-12 h-12 text-orange-600 animate-spin mb-4" /> : <Camera size={48} className="mb-4 text-stone-600" />}
                <p className="text-[10px] font-bold uppercase tracking-[0.3em]">
                    {loading ? "กำลังสถาปนานิมิตพรีเมียม..." : "รอรับนิมิตเพื่อสร้างรายได้"}
                </p>
              </div>
            )}
          </div>

          {/* Style Selection */}
          <div className="space-y-3">
            {styles.map(s => (
              <button key={s.id} onClick={() => setStyle(s.id)} className={`w-full p-4 rounded-2xl border-2 text-left flex justify-between items-center transition-all ${style === s.id ? 'bg-orange-950/20 border-orange-600' : 'bg-stone-900 border-stone-800'}`}>
                <div>
                  <p className={`text-[10px] font-black uppercase ${style === s.id ? 'text-orange-400' : 'text-stone-500'}`}>{s.name}</p>
                  <p className="text-[9px] text-stone-600 font-bold">{s.desc}</p>
                </div>
                {style === s.id && <Check size={16} className="text-orange-400" />}
              </button>
            ))}
          </div>

          <button onClick={generateImage} disabled={loading || energy < 25} className="w-full py-5 bg-orange-700 text-white font-black rounded-3xl shadow-xl active:scale-95 transition-all flex items-center justify-center gap-3 disabled:opacity-30">
            <Sparkles size={20} /> {loading ? "กำลังเนรมิต..." : "เริ่มการเนรมิตพยัคฆ์"}
          </button>
        </div>
      ) : renderMarketplace()}

      {/* Footer Nav */}
      <nav className="fixed bottom-0 left-0 right-0 h-24 bg-[#1c1917]/95 backdrop-blur-2xl border-t border-stone-800 flex justify-around items-center px-10 z-40 max-w-md mx-auto">
        <div className="flex flex-col items-center gap-1 text-orange-500"><Briefcase size={20} /><span className="text-[7px] font-bold uppercase">Business</span></div>
        <div className="flex flex-col items-center gap-1 text-stone-700"><TrendingUp size={20} /><span className="text-[7px] font-bold uppercase">Market</span></div>
        <div className="flex flex-col items-center gap-1 text-stone-700"><History size={20} /><span className="text-[7px] font-bold uppercase">History</span></div>
      </nav>

      {/* Notification */}
      {notification && (
        <div className="fixed bottom-28 left-1/2 -translate-x-1/2 z-50 bg-stone-100 text-stone-900 px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 animate-in slide-in-from-bottom-2">
          <Check size={14} className="text-green-600" />
          <span className="text-[10px] font-black uppercase tracking-widest">{notification}</span>
        </div>
      )}
    </div>
  );
};

export default App;

